name: Deployment NestJS

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy NestJS backend using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            echo "ðŸ‘‰ Go to backend folder"
            cd /home/Backend_SocialNetwork

            echo "ðŸ‘‰ Pull latest code"
            git pull origin master

            echo "ðŸ‘‰ Install dependencies"
            npm install

            echo "ðŸ‘‰ Build NestJS"
            npm run build

            echo "ðŸ‘‰ Restart backend with PM2"
            pm2 restart backend-social || pm2 start dist/main.js --name backend-social

            pm2 save
